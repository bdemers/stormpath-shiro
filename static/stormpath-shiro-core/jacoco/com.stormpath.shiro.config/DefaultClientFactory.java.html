<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultClientFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stormpath Shiro :: Core</a> &gt; <a href="index.source.html" class="el_package">com.stormpath.shiro.config</a> &gt; <span class="el_source">DefaultClientFactory.java</span></div><h1>DefaultClientFactory.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015 Stormpath, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.stormpath.shiro.config;

import com.stormpath.sdk.api.ApiKey;
import com.stormpath.sdk.api.ApiKeyBuilder;
import com.stormpath.sdk.api.ApiKeys;
import com.stormpath.sdk.cache.CacheManager;
import com.stormpath.sdk.client.*;
import com.stormpath.sdk.lang.Classes;
import com.stormpath.sdk.lang.Strings;

import java.util.*;

import com.stormpath.sdk.impl.config.PropertiesSource;

/**
 *
 */
<span class="nc" id="L33">public class DefaultClientFactory {</span>

    public static final String STORMPATH_API_KEY_FILE = &quot;stormpath.client.apiKey.file&quot;;
    public static final String STORMPATH_AUTHENTICATION_SCHEME = &quot;stormpath.client.authenticationScheme&quot;;

    public static final String STORMPATH_CACHE_MANAGER = &quot;stormpath.client.cacheManager&quot;;

    public static final String STORMPATH_PROXY_HOST = &quot;stormpath.client.proxy.host&quot;;
    public static final String STORMPATH_PROXY_PORT = &quot;stormpath.client.proxy.port&quot;;
    public static final String STORMPATH_PROXY_USERNAME = &quot;stormpath.client.proxy.username&quot;;
    public static final String STORMAPTH_PROXY_PASSWORD = &quot;stormpath.client.proxy.password&quot;;

    public static final String STORMPATH_APPLICATION_HREF = &quot;stormpath.application.href&quot;;

    public static final String STORMPATH_BASEURL = &quot;stormpath.client.baseUrl&quot;;

    private Map&lt;String, String&gt; config;


    public Client createClient() {

<span class="nc" id="L54">        this.config = createConfig();</span>

<span class="nc" id="L56">        ClientBuilder builder = Clients.builder();</span>

<span class="nc" id="L58">        applyBaseUrl(builder);</span>

<span class="nc" id="L60">        applyApiKey(builder);</span>

<span class="nc" id="L62">        applyProxy(builder);</span>

<span class="nc" id="L64">        applyAuthenticationScheme(builder);</span>

<span class="nc" id="L66">        applyCacheManager(builder);</span>

<span class="nc" id="L68">        return builder.build();</span>
    }

    protected void applyBaseUrl(ClientBuilder builder) {

<span class="nc" id="L73">        String baseUrl = config.get(STORMPATH_BASEURL);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (Strings.hasText(baseUrl)) {</span>
<span class="nc" id="L75">            builder.setBaseUrl(baseUrl);</span>
        }
<span class="nc" id="L77">    }</span>

    protected void applyCacheManager(ClientBuilder builder) {

        CacheManager cacheManager;

<span class="nc" id="L83">        String cacheManagerClass = config.get(STORMPATH_CACHE_MANAGER);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (Strings.hasText(cacheManagerClass)) {</span>
<span class="nc" id="L85">            cacheManager = Classes.newInstance(cacheManagerClass);</span>
<span class="nc" id="L86">            builder.setCacheManager(cacheManager);</span>
        }
<span class="nc" id="L88">    }</span>

    protected void applyApiKey(ClientBuilder clientBuilder) {
<span class="nc" id="L91">        ApiKey apiKey = createApiKey();</span>
<span class="nc" id="L92">        clientBuilder.setApiKey(apiKey);</span>
<span class="nc" id="L93">    }</span>

    protected ApiKey createApiKey() {

<span class="nc" id="L97">        ApiKeyBuilder apiKeyBuilder = ApiKeys.builder();</span>

<span class="nc" id="L99">        String value = config.get(&quot;stormpath.client.apiKey.id&quot;);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (Strings.hasText(value)) {</span>
<span class="nc" id="L101">            apiKeyBuilder.setId(value);</span>
        }

        //check for API Key ID embedded in the properties configuration
<span class="nc" id="L105">        value = config.get(&quot;stormpath.client.apiKey.secret&quot;);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (Strings.hasText(value)) {</span>
<span class="nc" id="L107">            apiKeyBuilder.setSecret(value);</span>
        }

<span class="nc" id="L110">        value = config.get(STORMPATH_API_KEY_FILE);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (Strings.hasText(value)) {</span>
<span class="nc" id="L112">            apiKeyBuilder.setFileLocation(value);</span>
        }

<span class="nc" id="L115">        return apiKeyBuilder.build();</span>
    }

    protected void applyProxy(ClientBuilder builder) {

<span class="nc" id="L120">        String proxyHost = config.get(STORMPATH_PROXY_HOST);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!Strings.hasText(proxyHost)) {</span>
<span class="nc" id="L122">            return;</span>
        }

        //otherwise, proxy config is present:

        Proxy proxy;

<span class="nc" id="L129">        int port = 80; //default</span>
<span class="nc" id="L130">        String portValue = config.get(STORMPATH_PROXY_PORT);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (Strings.hasText(portValue)) {</span>
<span class="nc" id="L132">            port = Integer.parseInt(portValue);</span>
        }

<span class="nc" id="L135">        String proxyUsername = config.get(STORMPATH_PROXY_USERNAME);</span>
<span class="nc" id="L136">        String proxyPassword = config.get(STORMAPTH_PROXY_PASSWORD);</span>

<span class="nc bnc" id="L138" title="All 4 branches missed.">        if (Strings.hasText(proxyUsername) || Strings.hasText(proxyPassword)) {</span>
<span class="nc" id="L139">            proxy = new Proxy(proxyHost, port, proxyUsername, proxyPassword);</span>
        } else {
<span class="nc" id="L141">            proxy = new Proxy(proxyHost, port);</span>
        }

<span class="nc" id="L144">        builder.setProxy(proxy);</span>
<span class="nc" id="L145">    }</span>

    protected void applyAuthenticationScheme(ClientBuilder builder) {
<span class="nc" id="L148">        String schemeName = config.get(STORMPATH_AUTHENTICATION_SCHEME);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (Strings.hasText(schemeName)) {</span>
<span class="nc" id="L150">            AuthenticationScheme scheme = AuthenticationScheme.valueOf(schemeName.toUpperCase());</span>
<span class="nc" id="L151">            builder.setAuthenticationScheme(scheme);</span>
        }
<span class="nc" id="L153">    }</span>

    protected Map&lt;String, String&gt; createConfig() {

<span class="nc" id="L157">        Map&lt;String, String&gt; configMap = new HashMap&lt;String, String&gt;();</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">        for (PropertiesSource source : getPropertySources()) {</span>
<span class="nc" id="L160">            configMap.putAll(source.getProperties());</span>
<span class="nc" id="L161">        }</span>
<span class="nc" id="L162">        return configMap;</span>
    }

    protected Collection&lt;PropertiesSource&gt; getPropertySources() {
<span class="nc" id="L166">        return Collections.emptyList();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>